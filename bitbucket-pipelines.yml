pipelines:
  branches:
    main:
      - step:
          name: Build and Deploy Thinkrisk React App
          runs-on:
            - self.hosted
            - linux
          image: ""   # â¬…ï¸ this makes it run directly on the runner host, not in a docker image
          script:
            - echo "ğŸ”¹ Cleaning up old containers..."
            - docker rm -f thinkrisk-react-app || true

            - echo "ğŸ”¹ Cleaning up dangling images..."
            - docker image prune -f || true

            - echo "ğŸ”¹ Building Docker image..."
            - docker build -t thinkrisk-react-app .

            - echo "ğŸ”¹ Installing Grype..."
            - curl -sSfL https://get.anchore.io/grype | sudo sh -s -- -b /usr/local/bin

            - echo "ğŸ”¹ Running Grype scan..."
            - chmod +x ./grype_exe.sh
            - ./grype_exe.sh thinkrisk-react-app

            - echo "ğŸ”¹ Starting container..."
            - docker run -d -p 443:3000 --restart always --name thinkrisk-react-app thinkrisk-react-app

            - echo "ğŸ”¹ Sending notification email..."
            - chmod +x send_email.sh
            - ./send_email.sh

pipelines:
  branches:
    main:
      - step:
          name: Build and Deploy Thinkrisk React App
          runs-on:
            - self.hosted
            - linux
          script:
            # Cleanup any old container with same name
            - echo "ðŸ”¹ Cleaning up old containers..."
            - docker rm -f thinkrisk-react-app || true

            # Remove dangling images to save space
            - echo "ðŸ”¹ Cleaning up dangling images..."
            - docker image prune -f || true

            # Build Docker image
            - echo "ðŸ”¹ Building Docker image..."
            - docker build -t thinkrisk-react-app .

            # Install Grype (vulnerability scanner)
            - echo "ðŸ”¹ Installing Grype..."
            - curl -sSfL https://get.anchore.io/grype | sudo sh -s -- -b /usr/local/bin

            # Run vulnerability scan
            - echo "ðŸ”¹ Running Grype scan..."
            - chmod +x ./grype_exe.sh
            - ./grype_exe.sh thinkrisk-react-app

            # Run Docker container (HTTPS on port 443 -> mapped to 3000 inside container)
            - echo "ðŸ”¹ Starting container..."
            - docker run -d -p 443:3000 --restart always --name thinkrisk-react-app thinkrisk-react-app

            # Send deployment notification email
            - echo "ðŸ”¹ Sending notification email..."
            - chmod +x send_email.sh
            - ./send_email.sh
